accelerator:
  displayName: Kubernetes Java Web App
  description: Tanzu Java Spring-Boot Web App, displaying kubernetes info.
  iconUrl: https://upload.wikimedia.org/wikipedia/labs/b/ba/Kubernetes-icon-color.svg
  tags:
  - Java
  - Kubernetes
  - Spring-Boot

  options: # a list of options
    - name: greetingMessage
      label: Greeting Message
      description: Greeting message displayed by the Hello World app.
      dataType: string
      inputType: text
      required: true
      defaultValue: Welcome to TAP accelerator demo!

    - name: greetingDescription
      label: Greeting Description
      description: Greeting message description displayed by the Hello World app.
      dataType: string
      inputType: text
      required: true
      defaultValue: by Cloud Native Applications team.

    - name: jvmVersion
      label: JVM Version
      description: Java Virtual Machine Version.
      inputType: select
      dataType: string # [string | boolean | number]
      choices:
      - text: "Java 17"
        value: "17" 
      - text: "Java 15"
        value: "15"
      - text: "Java 13"
        value: "13"
      - text: "Java 11"
        value: "11"
      defaultValue: "11"
      required: true
    
    - name: enableLiveUpdate
      label: Enable Live Update
      description: Enables Live Update & Live Debug features
      inputType: checkbox
      dataType: boolean
      required: true
      defaultValue: false

    - name: chooseCluster
      label: Choose Cluster
      description: Choose which clusters to auto-configure for the project, or specify a custom context of a specific cluster.
      inputType: select
      dataType: string
      choices:
      - text: "All Clusters"
        value: all 
      - text: "Only Local Clusters"
        value: local
      - text: "Specific Cluster"
        value: specificCluster
      defaultValue: all
      dependsOn:
        name: enableLiveUpdate
      required: true

    - name: clusterContext
      label: Cluster Context
      description: Specify the cluster's context
      dataType: string
      inputType: text
      required: true
      defaultValue: ""
      dependsOn: 
        name: chooseCluster
        value: specificCluster

engine:
  merge:     
    - include: ['*/**']
      exclude: ['Tiltfile', 'config/**', 'catalog/*.yaml', 'target/**', 'docs/**', '.vscode/**', "**/*.java"]
    
    - include: ["config/**", "catalog/*.yaml"]
      exclude: ["catalog/docs/**"]
      chain:
        - type: ReplaceText
          substitutions:
            - text: "default-greeting-message"
              with: "#greetingMessage"
            - text: "default-greeting-description"
              with: "#greetingDescription"
            - text: "default-project-name"
              with: "#projectName"
            - text: "default-java-version"
              with: "#jvmVersion"
        - type: YTT
    
    - include: ["**/*.java"]
      chain:
        - type: RewritePath
          regex: (?<prefix>.*)org.example.app(?<suffix>.*)
          rewriteTo: "#prefix + #projectName + #suffix" # SpEL expression. You can use '#g1' and '#g2' to reference 'match groups'
        - type: ReplaceText
          regex:
            pattern: 'org.example.app'
            with: "org.example. + #projectName"
          # substitutions:
          #   - text: "org.example.app"
          #     with: "org.example.#projectName"
    
    - include: ['Tiltfile']
      condition: "#chooseCluster == 'all' and #enableLiveUpdate"
      chain:
        - type: ReplaceText
          substitutions:
            - text: "<default-project-name>"
              with: "#projectName"
            - text: "'<k8s-context>'"
              with: "'k8s_context()'"
    
    - include: ['Tiltfile']
      condition: "#chooseCluster == 'local' and #enableLiveUpdate"
      chain:
        - type: ReplaceText
          substitutions:
            - text: "<default-project-name>"
              with: "#projectName"
            - text: "allow_k8s_contexts('<k8s-context>')" 
              with: "#clusterContext" # cannot be empty string, bypassing by setting a null var as replacement text
    
    - include: ['Tiltfile']
      condition: "#chooseCluster == 'specificCluster' and #enableLiveUpdate"
      chain:
        - type: ReplaceText
          substitutions:
            - text: "<project-name>"
              with: "#projectName"
            - text: "<k8s-context>"
              with: "#clusterContext"
            
  # # onConflict: UseFirst
    

